= 3. OpenShift GitOpsとの統合- 20分
:imagesdir: ../assets/images

== 本演習の目標

本演習では、 link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.11/html-single/cicd/index#about-redhat-openshift-gitops_understanding-openshift-gitops[OpenShift GitOps (ArgoCD)^] を使って、モダナイゼーションされたお客様アプリケーションをOpenShiftに構築し、デプロイすることが目標です。

* モダナイゼーションされた *customers* サービスを指すように、 *gateway* サービスの構成を更新
* *frontend* のサービスが以前と同じように動作可能か確認

== 3.1. ArgoCDでGatewayアプリケーションを同期

=== 3.1.1 OpenShift GitOpsを使用する理由

`GitOps` を端的に説明すると、 *Git pull requests* を使ってインフラストラクチャやアプリケーションの設定を管理するための一連のプラクティスです。GitOpsにおけるGitリポジトリは、信頼できる唯一の情報源とみなされ、システムの状態全体を含むため、システムの状態に対する変更の痕跡を可視化し、監査可能です。

GitOpsにおける変更のトレーサビリティは、アプリケーションのソースコードに対して広く採用されているため、それ自体は特に目新しいものではありません。しかし、GitOpsは、同じ原則（`レビュー`、`プルリクエスト`、`タグ付け` など）をインフラストラクチャやアプリケーションの設定に適用し、チームがアプリケーションのソースコードと同じ保証から恩恵を受けられるようにすることを提唱しています。

正確な定義や合意された一連のルールはありませんが、以下の原則がGitOpsの実践を構成するものと類似しています。

* システムに対する宣言的な記述はGitに保存される（設定、モニタリングなど）
* システムの状態変更はプルリクエストで行う
* Git Pushで稼働中のシステムの状態とGitリポジトリの状態を照合する

=== 3.1.2 ゲートウェイ設定の更新

`ゲートウェイ` 設定を更新する前に、現在の `gateway-config` ConfigMapの、 link:https://console-openshift-console.%SUBDOMAIN%/k8s/ns/retail-%USERID%/configmaps/gateway-config[application.yaml^] ファイル内の設定値を確認します。

image::gateway-config.png[gateway-config]

ArgoCDの管理コンソールの link:https://argocd-server-retail-%USERID%.%SUBDOMAIN%/applications/applications?view=tree&resource=&node=argoproj.io%2FApplication%2Fretail-%USERID%%2Fapplications%2F0&tab=parameters[APP DETAILS^] に戻り、`EDIT` をクリックしてください。

image::gateway-config-argo.png[gateway-config-argo]

`customersHost` を以下の値に置き換えてください。

[.console-input]
[source,yaml]
----
customersHost: customers
----

設定値を変更後、 `Save` をクリックし、右上の `X` をクリックしてポップアップウィンドウを閉じます。

`gateway` アプリケーションの `OutOfSync` ステータスが表示されますが、これはArgoCDのアプリケーションパラメータが、「retail-%USERID%」プロジェクトの link:https://console-openshift-console.%SUBDOMAIN%/k8s/ns/retail-%USERID%/configmaps/gateway-config[gateway-config ConfigMap^] の設定値と異なるものを更新したためです。

image::argocd-gateway-outofsync.png[argocd-gateway-outofsync]

`SYNC` をクリックし、その後、左のポップアップウィンドウで `SYNCHRONIZE` をクリックしてください。

image::argocd-gateway-sync.png[argocd-gateway-sync]

同期実行後、アプリケーションはすぐに同期されます。

image::argocd-gateway-synced.png[argocd-gateway-synced]

同期処理後、OpenShiftの管理コンソールに戻り、コード変更に基づき、 `gateway-config` が更新されているかどうかを確認します。

image::gateway-new-configmap.png[gateway-new-configmap]

== 3.2. GLOBEXのwebページを再訪問

link:https://ordersfrontend-retail-%USERID%.%SUBDOMAIN%[GLOBEX webページ^] にある `Customers` に戻ってください。

image::frontend.png[Frontend]

[NOTE]
====
「Customers」アプリケーションが OpenShift Virtualization 上のデータベースにアクセスできず、 `- java.sql.SQLSyntaxErrorException: ORA-00942: table or view does not exist.` エラーのため、「Customers」データに対して 「Unknown result」が表示される可能性がありますが、その場合は、OpenShiftの管理コンソールでpodを削除して、 `customers pod` を再起動してください。
====

== まとめ

以上で、OpenShift PipelineとGitOpsを統合して、継続的デリバリーの自動化を行うことで、「New Customers」アプリケーションのデプロイに成功しました。`モジュール4` では、イベント駆動型アーキテクチャの実装について学習します。

== Additional Resources

* https://www.redhat.com/en/topics/application-modernization[Understanding application modernization^]
* https://www.redhat.com/en/topics/devops/what-cicd-pipeline[Cloud-native CI/CD on OpenShift^]
* https://www.redhat.com/en/resources/java-app-modernization-with-openshift-e-book[eBook - Plan your Java application modernization journey^]
* https://kubebyexample.com/en/learning-paths/migrating-kubernetes/assess-and-refactor-tackle[Migrating Kubernetes Learning Path^]
