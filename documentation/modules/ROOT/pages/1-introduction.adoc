= 1. はじめに – 10分
:imagesdir: ../assets/images

[NOTE]
====
前モジュールの導入演習をすでに受講済みの場合は、そのまま 「CI/CDパイプラインの構築」 演習までスキップしてください。
====

ワークロードのクラウドへのマイグレーションやモダナイゼーションに関する一般的な表現は、 *6R フレームワーク* と呼ばれています。このフレームワークは、以下のように分解することができます。

image::mod-strategies-m3.png[Modernization Strategies]

[IMPORTANT]
====
Globexの開発者は、 https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/6.0/html-single/introduction_to_the_migration_toolkit_for_applications/index[Migration Toolkit for Applications (MTA)^] のアセスメント、分析ツールを使って、レガシーアプリケーション (*customers*) をRed Hat OpenShiftにモダナイズ済みです。一方、SREチームも `モジュール 1` と `モジュール 2` により、Red Hat VirtualizationからOpenShift VirtualizationへのOracleデータベースのマイグレーションを完了しています。
====

このモジュールでは、2つのフェーズ（_パイプライン_、_GitOps_）を通じて、以下の手順にて高度なビルドとデプロイメント機能を構築します。

* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.11/html-single/cicd/index#op-detailed-concepts[OpenShift Pipeline^] をベースとした継続的インテグレーションおよび継続的デリバリー（CI/CD）を以下の主要機能で構築します。

** 必要となるすべての依存関係を持つパイプラインを、隔離されたコンテナで実行するサーバーレスにおけるCI/CDシステムの構築
** マイクロサービスベースのアーキテクチャで自動化作業を設計する分散型チームの実現。
** 既存のKubernetesツールとの拡張や統合を容易にする、標準的なCI/CDパイプライン定義を使用し、オンデマンドでの拡張を実現。
** Source-to-Image（S2I）、Buildah、Buildpacks、KanikoなどのKubernetesツールでのイメージの構築を可能にし、任意のKubernetesプラットフォームにおける移植の実現
** OpenShift Container Platform Developerコンソールを使用して、Tektonリソースの作成、パイプライン実行のログの表示、OpenShift Container Platformネームスペースのパイプラインの管理の実施。

* モダナイゼーションされたアプリケーションをRed Hat OpenShiftにデプロイする際に使用する link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.11/html-single/cicd/index#about-redhat-openshift-gitops_understanding-openshift-gitops[OpenShift GitOps (ArgoCD)^] には、以下主要機能があります。

** 対象のクラスタがそれぞれ、構成、モニタリング、ストレージ状態が類似しているかどうかの確認
** 複数のOpenShift Container Platformクラスタへの設定変更の適用、または設定戻しの実行
** さまざまな環境に対応しているテンプレート化された構成
** ステージング環境から本番環境の、クラスタ間でアプリケーションのプロモート作業

== 1.1. Globex Retailのシステムアーキテクチャの理解

Globexは、今回のワークショップで使用する架空の企業です。ワークショップ環境のGlobexのシステムは、以下のように仮想マシンやコンテナプラットフォームなど複数のプラットフォームにデプロイされたマイクロサービスアプリケーションで構成されています。

image::architecture_initial-m3.png[architecture_initial-m3]

このワークショップの初期状態は、Red Hat VirtualizationとRed Hat OpenShift Container Platformに分散された環境です。

今回使用するアプリケーションは、すでにレガシー環境からOpenShiftに一部移行されている状態となります。

Globex Retailのアプリケーションは、Node.jsのフロントエンドサービスから構成され、ゲートウェイサービスを通じてデータを取得します。ゲートウェイサービスは、「Customers」、「Orders」、「inventory」という3つのバックエンドサービスに接続されています。各サービスは、データを保存するためにそれぞれ独自のデータベースを使用します。

OpenShift上で動作するサービスは、「namespace retail-%USERID%」にデプロイされます。このサービスは最終的に *OpenShift GitOps* と *Pipelines* を使って管理することになります。

[NOTE]
====
_ImagePullBackOffエラー_ のため、「Customers」のPodがFailed状態となっている可能性がありますが、こちらはOpenShiftのCI/CDとGitOpsのセクションを終了後に、自動的に修正されます。
====

アプリケーションのすべてのソースコードおよびすべてのサービスのGitOps YAML Manifestは、このワークショップ向けにOpenShiftクラスタでホストされている（Git互換の） *Gitea* リポジトリに格納されています。

現在の問題となっているものは、 *customers* サービスです。

* 「Customers」サービスでは、 `Red Hat Virtualization` 上のVMで `Apache Tomcat` 上で動作する古いJavaコードベースを使用しています。最終的に、このJava コードのモダナイゼーションを実現し、Red Hat JBoss Web Server の上にある OpenShift にこのアプリケーションをデプロイします。
* 「Customers」のデータベースは、Red Hat VirtualizationのVMとして動作する `Oracleデータベース` を使用していますが、この場合、データベースがOracleであるため、OpenShift上でこのデータベースをPodとしてデプロイすることはできません。したがって、 `OpenShift Migration Toolkit for Virtualization` で移行した `OpenShift Virtualization` に基づく新しい仮想マシンを使用する必要があります。

このワークショップのすべてのモジュールを受講後、皆様のデプロイメントアーキテクチャは以下になります。

image::architecture_completed.png[architecture_completed]

== 1.2. ワークショップで使用する環境

=== 1.2.1. ユーザー名の確認

画面上部のボックスにて、ユーザー名はすでに設定されているかご確認ください。設定されている場合、以下のように表示されます。

image::alreadyset.png[alreadyset]

`ユーザー名` が正しく設定されていることを確認後、次に進んでください。 *確認できない場合は、上記のボックスに、割り当てられたユーザーIDを以下のように入力してください* 。

image::setuser.png[setuser]

こちらを実施後、このワークショップのリンクとコピー/ペーストコードが設定変更されます。誤ったユーザー名を入力した場合は、URLパラメータでユーザー名を更新してください（例：`1-introduction.html?USERID=%USERID%`）

[IMPORTANT]
====
ハンズオンラボを受講中は、固有のユーザー名（例： `%USERID%` ）を使用する必要があります。例として、自分のプロジェクト（例：retail-%USERID%）にアプリケーションをデプロイする必要があります。
====

=== 1.2.2. OpenShiftクラスタ

このワークショップのOpenShiftクラスタには、使用するものがすでに構成されています。以下はその詳細となります。

* ソースコードリポジトリをホストする `Gitea` 
* 移行したOracle VMを最終的に稼働させる `OpenShift Virtualization`
* Oracle VMからRed Hat OpenShift Container Platformへの移行を容易にする `Migration Toolkit for Virtualization` 
* ArgoCDによるGitOpsアプローチでデプロイされたサービスを管理する `OpenShift GitOps`

* ソースコードからお客様のアプリケーションを構築する `OpenShift Pipelines` および `retail` プロジェクトにデプロイするGitOps
* お客様のサービスのモダナイゼーションを支援する `Migration Toolkit for Applications`

=== 1.2.3. Visual Studio Code Server

VSCodeはOpenShiftクラスタにデプロイ済みのため、IDEとして使用可能です。そのため、システムに追加でインストールまたは設定を行う必要はありません。これにより、クローンリポジトリ内のソースコードや設定ファイルを簡単に変更できます。

はじめに、 link:https://codeserver-codeserver-%USERID%.%SUBDOMAIN%[VS Code server インスタンス^] にアクセスし、以下のパスワードでログインしてください。

* Password: `{openshift-password}`

image::vscode-server-login.png[vscode-server-login]

グラフィカルユーザーインターフェース（GUI）には、以下の特徴があります。

image::vscode.png[VSCode]

== 1.3. Globex Retailのサービスの調査（GUI）

フロントエンドのWebアプリケーションにアクセスして、Global Retailのサービスアプリケーションにアクセスできることを確認してください。 *フロントエンド* アプリケーションへのアクセスURLは、OpenShiftのコマンドラインツール（`oc`）を使用する必要があります。VS Code Serverを開き、デフォルトで _oc_ コマンドがインストールされているターミナルを新たに開いてください。

VS Codeのターミナルメニューにある `新しいターミナル` をクリックし、新しいターミナルが開いたら、以下の _oc_ コマンドを実行してください。

[.console-input]
[source,bash]
----
oc login -u %USERID% -p openshift https://openshift.default.svc:443
----

image::vscode-terminal.png[vscode-terminal]

[注]
====
コピー&ペーストの許可に関する *See text and images copied to the clipboard* というポップアップメッセージが表示されたら、 `Allow` をクリックします。その際に、ターミナルで `"Use insecure connections?"` というメッセージも表示される可能性もありますが、その場合は、 `y` を入力してください。
====

*フロントエンド* アプリケーションの `ルート` URLを検索するため、VS Code Serverのターミナルで、以下の `oc` コマンドを実行してください。

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc get route ordersfrontend -n retail-%USERID%
----

以下は出力内容の一例です。

[.console-output]
[source,bash,subs="+attributes,macros+"]
----
NAME             HOST/PORT                                                                PATH   SERVICES         PORT   TERMINATION     WILDCARD
ordersfrontend   ordersfrontend-retail-%USERID%.%SUBDOMAIN%          ordersfrontend   web    edge/Redirect   None
----

ブラウザのアドレスバーに `HOST/PORT` に上記のホスト名を入力し、オーダーに対してのフロントエンドルートに移動します。

image::frontend.png[Frontend]

左側の3つのパネルをクリックしてください。

* `Customers` には、フルネーム、_都市名、国名、ユーザー名_などの顧客情報の一覧が表示されます。
* `Orders` には、関連する顧客データを含む現在のオーダー情報が表示されます。
* `Products` には、現在の在庫情報が表示されます。

== 1.4. お客様のデータへのアクセス

RHV環境は、デプロイされたOracle Database VMを管理するだけでなく、Apache Tomcatの上でお客様の古いアプリケーションを実行する別のVMもホスティングされているため、まだ稼働しています。

以下の手順にて、レガシーアプリケーションである「Customers」のデータにアクセスできます。そして、OpenShift PipelineとGitOpsを使用して、新しいモダナイゼーションされたアプリケーションをデプロイした後、新旧アプリケーションを比較して新しいお客様のデータ検証を行います。

ターミナルウィンドウから `curl` コマンドを実行し、アプリケーションがデータベースに接続されているかどうか確認できます。

*Customer Service (Tomcat VM)* のIPアドレスを使用して、「Customers」サービスにアクセスしてください。アクセスするには、VS Code Serverのターミナル（もしくはTomcatの公開されているIPアドレスを用いてローカル環境）で、以下の _curl_ コマンドを実行します。

[.console-input]
[source,bash]
----
curl http://%TOMCATIP%:8080/customers-tomcat-0.0.1-SNAPSHOT/customers/1 ; echo
----

以下は出力内容の一例です。

[.console-output]
[source,json]
----
{"id":1,"username":"phlegm_master_19","name":"Guybrush","surname":"Threepwood","address":"1060 West Addison","zipCode":"ME-001","city":"Melee Town","country":"Melee Island"}
----

別の顧客データを取得してください。

[.console-input]
[source,bash]
----
curl http://%TOMCATIP%:8080/customers-tomcat-0.0.1-SNAPSHOT/customers/2 ; echo
----

以下は出力内容の一例です。

[.console-output]
[source,json]
----
{"id":2,"username":"hate_guybrush","name":"Pirate","surname":"Lechuck","address":"Caverns of Meat, no number","zipCode":"MO-666","city":"Giant Monkey Head","country":"Monkey Island"}
----

== おめでとうございます。

以上で、アプリケーションのアーキテクチャの学習、ワークショップの環境の確認が完了しました。

次のステップでは、Configuratioun as codeのセットアップを行い、GitOpsアプローチを使って、ビルドからテスト、本番までのアプリケーションライフサイクルを自動化することで、モダナイゼーションプロセスの継続を図ります。
